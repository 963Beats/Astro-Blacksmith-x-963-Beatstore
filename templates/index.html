<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astro Blacksmith | Beat Store</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>[x-cloak] { display: none !important; }</style>
</head>

<body class="bg-[#0b0e17] text-slate-100 font-sans"
      x-data="playerData()"
      x-init="init()">

<!-- MOBILE HEADER -->
<div class="md:hidden bg-[#0f1322] border-b border-slate-800 p-4 sticky top-0 z-50 flex justify-between items-center">
    <span class="font-black text-emerald-400">SELECT GENRE ></span>

    <div class="relative" x-data="{ open: false }">
        <button @click="open = !open"
                class="bg-slate-800 px-4 py-2 rounded-lg text-xs font-bold uppercase">
            <span x-text="activeGenre?.name || 'Genres'"></span> ↓
        </button>

        <div x-show="open"
             @click.away="open = false"
             class="absolute right-0 mt-2 w-56 bg-[#161b30] border border-slate-700 rounded-xl shadow-2xl z-50">
            <template x-for="g in genres" :key="g.folder">
                <button
                    @click="selectGenre(g); open = false"
                    class="w-full text-left px-4 py-3 text-sm hover:bg-emerald-500 hover:text-black transition-colors"
                    x-text="g.name">
                </button>
            </template>
        </div>
    </div>
</div>

<div class="flex h-screen">

<!-- SIDEBAR -->
<aside class="w-72 bg-[#0f1322] border-r border-slate-800 hidden md:flex flex-col">
    <div class="p-8">
        <h1 class="text-xl font-black text-emerald-400">ASTRO BLACKSMITH</h1>
    </div>

    <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
        <template x-for="g in genres" :key="g.folder">
            <button
                @click="selectGenre(g)"
                :class="activeGenre?.folder === g.folder
                    ? 'bg-emerald-500/10 text-emerald-400 border-l-4 border-emerald-500'
                    : 'text-slate-400 hover:text-white'"
                class="w-full text-left px-4 py-3 rounded-lg text-sm font-bold transition-all"
                x-text="g.name">
            </button>
        </template>
    </nav>
</aside>

<!-- MAIN -->
<main class="flex-1 overflow-y-auto pb-32">

<header class="p-8 md:p-12 bg-gradient-to-b from-emerald-900/10 to-transparent">
    <div class="flex flex-col md:flex-row items-center gap-8">

        <div class="w-48 h-48 rounded-2xl shadow-2xl bg-slate-800 bg-cover bg-center"
             :style="activeGenre?.beats?.length
                ? `background-image:url('/visuals/${activeGenre.folder}/${activeGenre.beats[0].image}')`
                : ''">
        </div>

        <div class="text-center md:text-left">
            <h1 class="text-4xl md:text-6xl font-black mb-2"
                x-text="activeGenre?.name || ''"></h1>
            <p class="text-slate-400">Premium Beats • Instant Delivery</p>
        </div>

    </div>
</header>

<div class="px-4 md:px-12">
    <template x-for="beat in activeGenre?.beats || []" :key="beat.file">
        <div
            @click="playTrack(beat)"
            class="flex items-center gap-4 p-3 rounded-xl hover:bg-white/5 cursor-pointer group transition-all">

            <img
                :src="`/visuals/${activeGenre.folder}/${beat.image}`"
                class="w-12 h-12 rounded-lg object-cover">

            <div class="flex-1">
                <div class="font-bold" x-text="beat.title"></div>
                <div class="text-xs text-slate-500 uppercase"
                     x-text="activeGenre.name"></div>
            </div>

            <button
                @click.stop="openLease(beat)"
                class="px-4 py-2 bg-emerald-500 text-black text-xs font-black rounded-full hover:scale-105 transition">
                BUY
            </button>
        </div>
    </template>
</div>

</main>
</div>

<!-- PLAYER -->
<footer x-show="currentTrack"
        x-cloak
        class="fixed bottom-0 inset-x-0 bg-[#0f1322]/95 backdrop-blur-md border-t border-slate-800 p-4 z-50">

<div class="max-w-screen-xl mx-auto flex items-center gap-4 md:gap-8">

    <img
        x-show="currentTrack"
        :src="`/visuals/${activeGenre.folder}/${currentTrack.image}`"
        class="w-12 h-12 rounded hidden sm:block">

    <div class="flex-1">
        <div class="text-sm font-bold truncate"
             x-text="currentTrack?.title"></div>

        <input type="range"
               min="0"
               max="100"
               class="w-full h-1 bg-slate-700 rounded-lg appearance-none accent-emerald-400"
               :value="progress"
               @input="seek($event.target.value)">
    </div>

    <button
        @click="togglePlay"
        class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center text-lg shadow-lg"
        x-text="isPlaying ? 'II' : '▶'">
    </button>

</div>
</footer>

<!-- MODAL -->
<div x-show="modalOpen"
     x-cloak
     class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-sm">

<div @click.away="modalOpen = false"
     class="bg-[#161b30] w-full max-w-md rounded-3xl p-8 border border-slate-700 shadow-2xl">

<h3 class="text-2xl font-black mb-6 text-emerald-400">Lease Inquiry</h3>

<form @submit.prevent="submitForm" class="space-y-4">

<input type="hidden" name="Beat Title" :value="leasingBeat?.title">
<input type="hidden" name="Genre" :value="activeGenre?.name">

<div class="bg-slate-900 p-3 rounded-xl border border-slate-800 text-sm text-slate-400">
Target:
<span class="text-white font-bold" x-text="leasingBeat?.title"></span>
</div>

<input required name="name" placeholder="Full Name"
       class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl">

<input required type="email" name="email" placeholder="Email Address"
       class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl">

<button type="submit"
        :disabled="isSubmitting"
        class="w-full py-4 bg-emerald-500 text-black font-black rounded-xl disabled:opacity-50">
<span x-text="isSubmitting ? 'SENDING…' : 'GENERATE INVOICE'"></span>
</button>

</form>

<button @click="modalOpen = false"
        class="w-full mt-4 text-slate-500 text-sm font-bold">
Cancel
</button>

</div>
</div>

<script>
function playerData() {
    return {
        genres: {{ genres | tojson }},
        activeGenre: null,
        currentTrack: null,
        audio: new Audio(),
        isPlaying: false,
        progress: 0,
        modalOpen: false,
        leasingBeat: null,
        isSubmitting: false,

        init() {
            if (this.genres.length) {
                this.activeGenre = this.genres[0];
            }

            this.audio.ontimeupdate = () => {
                if (!this.audio.duration) return;
                this.progress = (this.audio.currentTime / this.audio.duration) * 100;
            };

            this.audio.onended = () => {
                this.isPlaying = false;
            };
        },

        selectGenre(g) {
            this.activeGenre = g;
            this.currentTrack = null;
            this.audio.pause();
            this.isPlaying = false;
            this.progress = 0;
        },

        playTrack(beat) {
            const src = `/audio/${this.activeGenre.folder}/${beat.file}`;
            if (this.audio.src !== window.location.origin + src) {
                this.audio.src = src;
            }
            this.currentTrack = beat;
            this.audio.play();
            this.isPlaying = true;
        },

        togglePlay() {
            if (!this.currentTrack) return;
            this.isPlaying ? this.audio.pause() : this.audio.play();
            this.isPlaying = !this.isPlaying;
        },

        seek(val) {
            if (!this.audio.duration) return;
            this.audio.currentTime = (val / 100) * this.audio.duration;
        },

        openLease(beat) {
            this.leasingBeat = beat;
            this.modalOpen = true;
        },

        async submitForm(e) {
            this.isSubmitting = true;
            const formData = new FormData(e.target);

            try {
                const res = await fetch("https://formspree.io/f/myzpglqg", {
                    method: "POST",
                    body: formData,
                    headers: { "Accept": "application/json" }
                });

                if (res.ok) {
                    alert("Invoice request sent!");
                    this.modalOpen = false;
                } else {
                    alert("Failed to send request.");
                }
            } catch {
                alert("Network error.");
            } finally {
                this.isSubmitting = false;
            }
        }
    }
}
</script>

</body>
</html>
