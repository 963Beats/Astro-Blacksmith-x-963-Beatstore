<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>963 | Beat Store</title>

{% if og_beat %}
<meta property="og:title" content="{{ og_beat.title }}">
<meta property="og:description" content="Prod. by 963 • Premium Beat">
<meta property="og:image" content="{{ request.url_root }}visuals/{{ og_beat.genre_folder }}/{{ og_beat.image }}">
<meta property="og:type" content="music.song">
<meta property="og:url" content="{{ request.url }}">
<meta name="twitter:card" content="summary_large_image">
{% else %}
<meta property="og:title" content="963 • Premium Beats">
<meta property="og:description" content="Underground premium beats">
<meta name="twitter:card" content="summary_large_image">
{% endif %}

<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>[x-cloak]{display:none!important}</style>
</head>

<body class="bg-[#0b0e17] text-slate-100"
x-data="playerData()"
x-init="init()">

<!-- MOBILE MENU -->
<div x-show="mobileMenuOpen" x-cloak class="fixed inset-0 z-50 bg-black/80 md:hidden">
  <div class="absolute left-0 top-0 bottom-0 w-72 bg-[#0f1322] p-6">
    <div class="flex justify-between mb-6">
      <h2 class="font-black text-emerald-400">Genres</h2>
      <button @click="mobileMenuOpen=false">✕</button>
    </div>
    <template x-for="g in genres" :key="g.folder">
      <button @click="selectGenre(g); mobileMenuOpen=false"
        class="w-full text-left px-4 py-3 rounded-lg font-bold text-slate-300 hover:bg-white/5">
        <span x-text="g.name"></span>
      </button>
    </template>
  </div>
</div>

<div class="flex h-screen overflow-hidden">

<!-- SIDEBAR -->
<aside class="hidden md:flex w-72 bg-[#0f1322] border-r border-slate-800 flex-col">
  <div class="p-8">
    <h1 class="text-xl font-black text-emerald-400">963</h1>
    <p class="text-[10px] text-slate-500 font-bold tracking-widest">PREMIUM BEATS</p>
  </div>
  <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
    <template x-for="g in genres" :key="g.folder">
      <button @click="selectGenre(g)"
        :class="activeGenre?.folder===g.folder
          ? 'bg-emerald-500/10 text-emerald-400 border-l-4 border-emerald-500'
          : 'text-slate-400 hover:bg-white/5'"
        class="w-full text-left px-4 py-3 rounded-lg font-bold">
        <span x-text="g.name"></span>
      </button>
    </template>
  </nav>
</aside>

<!-- MAIN -->
<main class="flex-1 overflow-y-auto">

<header class="p-8">
  <h1 class="text-4xl font-black" x-text="activeGenre?.name || 'Select Genre'"></h1>
</header>

<!-- BEATS -->
<div class="px-6 pb-40 space-y-2">
<template x-for="beat in activeGenre?.beats || []" :key="beat.file">
<div @click="openBeat(beat)"
class="flex items-center gap-4 p-3 rounded-xl cursor-pointer hover:bg-white/5"
:class="[
  beat.is_new ? 'ring-1 ring-emerald-400/30 bg-emerald-500/5' : '',
  focusedBeat?.file===beat.file ? 'bg-white/5 border-l-4 border-emerald-500' : ''
]">

<img :src="`/visuals/${beat.genre_folder}/${beat.image}`"
class="w-12 h-12 rounded-lg object-cover">

<div class="flex-1">
  <div class="flex gap-2 items-center">
    <span class="font-bold" x-text="beat.title"></span>
    <span x-show="beat.is_new" x-cloak
      class="text-[9px] px-2 rounded-full bg-emerald-400 text-black font-black">NEW</span>
  </div>
  <div class="text-[10px] text-slate-500 uppercase font-bold"
       x-text="activeGenre.name"></div>
</div>

<button @click.stop="shareBeat(beat)" class="p-2 hover:bg-white/10 rounded-full">
<i data-lucide="share-2"></i>
</button>

<button @click.stop="openLease(beat)"
class="px-4 py-2 bg-emerald-500 text-black font-black rounded-full text-[10px]">
BUY
</button>

</div>
</template>
</div>

<!-- PLAYER BAR -->
<div x-show="currentTrack" x-cloak
class="fixed bottom-0 left-0 right-0 bg-[#0f1322]/95 border-t border-slate-800 p-4">
<div class="flex items-center gap-4">
<img :src="`/visuals/${currentTrack.genre_folder}/${currentTrack.image}`"
class="w-12 h-12 rounded-lg object-cover">
<div class="flex-1">
  <div class="font-bold" x-text="currentTrack.title"></div>
</div>
<button @click="togglePlay()"
class="w-10 h-10 bg-white text-black rounded-full flex items-center justify-center">
<i :data-lucide="isPlaying?'pause':'play'"></i>
</button>
</div>
</div>

</main>
</div>

<!-- BEAT OVERLAY -->
<div x-show="focusedBeat" x-cloak
class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6">
<div class="bg-[#0f1322] rounded-2xl p-6 max-w-lg w-full relative">
<button @click="focusedBeat=null" class="absolute top-4 right-4">✕</button>

<img :src="`/visuals/${focusedBeat.genre_folder}/${focusedBeat.image}`"
class="w-full aspect-square rounded-xl mb-4">

<h2 class="text-2xl font-black" x-text="focusedBeat.title"></h2>

<div class="flex gap-3 mt-6">
<button @click="togglePlay()" class="flex-1 py-3 bg-white text-black font-black rounded-xl">
<span x-text="isPlaying?'PAUSE':'PLAY'"></span>
</button>
<button @click="openLease(focusedBeat)" class="flex-1 py-3 bg-emerald-500 text-black font-black rounded-xl">
BUY
</button>
<button @click="shareBeat(focusedBeat)" class="p-3 bg-slate-800 rounded-xl">
<i data-lucide="share-2"></i>
</button>
</div>
</div>
</div>

<!-- LEASE MODAL -->
<div x-show="modalOpen" x-cloak
class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center">
<div class="bg-[#161b30] p-8 rounded-2xl w-full max-w-md">
<h3 class="text-2xl font-black mb-2">Lease Beat</h3>
<p class="text-emerald-400 font-bold mb-4" x-text="leasingBeat?.title"></p>

<form @submit.prevent="submitForm">
<input type="hidden" name="beat" :value="leasingBeat?.title">

<input required name="name" placeholder="Your name"
class="w-full mb-3 p-4 rounded-xl bg-slate-900 border border-slate-700">

<input required type="email" name="email" placeholder="Email"
class="w-full mb-4 p-4 rounded-xl bg-slate-900 border border-slate-700">

<button :disabled="isSubmitting"
class="w-full py-4 bg-emerald-500 text-black font-black rounded-xl">
<span x-show="!isSubmitting && !submitSuccess">GENERATE INVOICE</span>
<span x-show="isSubmitting">SENDING…</span>
<span x-show="submitSuccess">✓ SENT</span>
</button>
</form>
</div>
</div>

<script>
function playerData(){
return{
genres:{{ genres|tojson }},
activeGenre:null,
currentTrack:null,
focusedBeat:null,
audio:new Audio(),
isPlaying:false,
mobileMenuOpen:false,
modalOpen:false,
leasingBeat:null,
isSubmitting:false,
submitSuccess:false,

init(){
this.activeGenre=this.genres[0]||null
lucide.createIcons()
},

selectGenre(g){
this.activeGenre=g
this.focusedBeat=null
history.pushState({}, "", "/")
},

openBeat(b){
this.focusedBeat=b
this.playTrack(b)
const slug=b.title.toLowerCase().replace(/\s+/g,'-')
history.pushState({}, "", `/beat/${b.genre_folder}/${slug}`)
},

playTrack(b){
if(this.currentTrack?.file===b.file){
this.togglePlay();return
}
this.audio.src=`/audio/${b.genre_folder}/${b.file}`
this.currentTrack=b
this.audio.play()
this.isPlaying=true
setTimeout(()=>lucide.createIcons(),50)
},

togglePlay(){
this.isPlaying?this.audio.pause():this.audio.play()
this.isPlaying=!this.isPlaying
setTimeout(()=>lucide.createIcons(),50)
},

openLease(b){
this.leasingBeat=b
this.modalOpen=true
},

async submitForm(e){
this.isSubmitting=true
const fd=new FormData(e.target)
await fetch("https://formspree.io/f/myzpglqg",{method:"POST",body:fd})
this.submitSuccess=true
setTimeout(()=>{
this.modalOpen=false
this.submitSuccess=false
this.isSubmitting=false
},1500)
},

async shareBeat(b){
const slug=b.title.toLowerCase().replace(/\s+/g,'-')
const url=`${location.origin}/beat/${b.genre_folder}/${slug}`
if(navigator.share){
await navigator.share({title:b.title,text:"Prod. by 963 • Premium Beat",url})
}else{
await navigator.clipboard.writeText(url)
alert("Beat link copied")
}
}
}}
</script>

</body>
</html>
