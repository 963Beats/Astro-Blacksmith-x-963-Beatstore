<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Astro Blacksmith | Beat Store</title>

<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<style>[x-cloak]{display:none!important}</style>
</head>

<body class="bg-[#0b0e17] text-slate-100 font-sans"
      x-data="playerData()"
      x-init="init()">

<div class="flex h-screen">

<!-- SIDEBAR -->
<aside class="w-72 bg-[#0f1322] border-r border-slate-800 hidden md:flex flex-col">
    <div class="p-8">
        <h1 class="text-xl font-black text-emerald-400">ASTRO BLACKSMITH</h1>
    </div>

    <nav class="flex-1 px-4 space-y-1 overflow-y-auto">
        <template x-for="g in genres" :key="g.folder">
            <button
                @click="selectGenre(g)"
                :class="activeGenre?.folder === g.folder
                    ? 'bg-emerald-500/10 text-emerald-400 border-l-4 border-emerald-500'
                    : 'text-slate-400 hover:text-white'"
                class="w-full text-left px-4 py-3 rounded-lg text-sm font-bold">
                <span x-text="g.name"></span>
            </button>
        </template>
    </nav>
</aside>

<!-- MAIN -->
<main class="flex-1 overflow-y-auto pb-32">

<header class="p-12 bg-gradient-to-b from-emerald-900/10 to-transparent">
    <h1 class="text-5xl font-black" x-text="activeGenre?.name"></h1>

    <p x-show="activeGenre?.beats?.some(b => b.is_new)"
       x-cloak
       class="mt-2 text-xs font-bold tracking-widest text-emerald-400">
        ✦ NEW UPLOADS TODAY
    </p>
</header>

<div class="px-4 md:px-12 space-y-2">
<template x-for="beat in activeGenre?.beats || []" :key="beat.file">
    <div
        @click="playTrack(beat)"
        :class="beat.is_new
            ? 'ring-1 ring-emerald-400/60 bg-emerald-500/5'
            : ''"
        class="flex items-center gap-4 p-3 rounded-xl hover:bg-white/5 cursor-pointer">

        <img :src="`/visuals/${activeGenre.folder}/${beat.image}`"
             class="w-12 h-12 rounded-lg object-cover">

        <div class="flex-1">
            <div class="flex items-center gap-2">
                <div class="font-bold" x-text="beat.title"></div>

                <span x-show="beat.is_new"
                      x-cloak
                      class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-400 text-black font-black">
                    NEW
                </span>
            </div>

            <div class="text-xs text-slate-500 uppercase"
                 x-text="activeGenre.name"></div>
        </div>

        <button
            @click.stop="openLease(beat)"
            class="px-4 py-2 bg-emerald-500 text-black text-xs font-black rounded-full">
            BUY
        </button>
    </div>
</template>
</div>

</main>
</div>

<!-- MODAL -->
<div x-show="modalOpen"
     x-cloak
     class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">

<div class="bg-[#161b30] w-full max-w-md rounded-2xl p-8 border border-slate-700">

<h3 class="text-xl font-black text-emerald-400 mb-4">Lease Inquiry</h3>

<form @submit.prevent="submitForm($event)" class="space-y-4">

    <input type="hidden" name="beat_title" :value="leasingBeat?.title || ''">
    <input type="hidden" name="genre" :value="activeGenre?.name || ''">

    <input required name="name" placeholder="Full Name"
           class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl">

    <input required type="email" name="email" placeholder="Email Address"
           class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl">

    <button type="submit"
            :disabled="isSubmitting"
            class="w-full py-3 bg-emerald-500 text-black font-black rounded-xl">
        <span x-text="isSubmitting ? 'SENDING…' : 'GENERATE INVOICE'"></span>
    </button>

</form>

<button @click="modalOpen=false"
        class="mt-4 text-xs text-slate-500 font-bold w-full">
    Cancel
</button>

</div>
</div>

<script>
function playerData(){
return{
genres: {{ genres | tojson }},
activeGenre:null,
currentTrack:null,
audio:new Audio(),
isPlaying:false,
modalOpen:false,
leasingBeat:null,
isSubmitting:false,

init(){
    this.activeGenre=this.genres[0]||null
},

selectGenre(g){
    this.activeGenre=g
    this.audio.pause()
    this.isPlaying=false
},

playTrack(beat){
    const src=`/audio/${this.activeGenre.folder}/${beat.file}`
    if(this.audio.src!==location.origin+src){
        this.audio.src=src
    }
    this.currentTrack=beat
    this.audio.play()
    this.isPlaying=true
},

openLease(beat){
    this.leasingBeat=beat
    this.modalOpen=true
},

async submitForm(e){
    this.isSubmitting=true
    const formData=new FormData(e.target)

    try{
        const res=await fetch("https://formspree.io/f/myzpglqg",{
            method:"POST",
            body:formData,
            headers:{Accept:"application/json"}
        })

        if(res.ok){
            alert("Invoice request sent")
            this.modalOpen=false
        }else{
            alert("Failed to send")
        }
    }catch{
        alert("Network error")
    }finally{
        this.isSubmitting=false
    }
}
}}
</script>

</body>
</html>
